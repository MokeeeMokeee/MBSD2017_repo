## 送信元偽装の脆弱性と暗号化・復号化ができる脆弱性により外部から不正な取引ができてしまう脆弱性
### 対象
* `mode/hidden_server.php`

### 危険度
High
* タイトルにある二つの脆弱性を組み合わせることにより、外部の銀行からの送金・外部の銀行への送金があったように見せかけることができる

### 解説
今回のプログラムでは、`util/getrealip.php`と `util/encrypt.php`, `util/decrypt.php`に前述した脆弱性がある。
この脆弱性を組み合わせることにより、外部の銀行から来たリクエストに偽装し共通鍵で暗号化された送金リクエストを送信することができる。

手順としては以下の通りとなる。
1. 送金に使うリクエストを`util/encrypt.php`に送信し、暗号文を生成する

2. 送信元を偽装したリクエストを`index.php?mode=hidden_server`に送信する

この手順が行われることで、サーバでは以下のフローで処理が行われる
1.  送金に使うリクエストを`util/encrypt.php`に送信し、暗号文を生成する
    1. 全銀用の共通鍵で暗号化した暗号文をクライアントに送信する
2. 送信元を偽装したリクエストを`index.php?mode=hidden_server`に送信する
    1. 送信元を照合し、正しいリクエストであると判断する (`hidden_server.php:4`)
    2. 1.で作成した暗号文を全銀用の共通鍵で復号する (`hidden_server.php:9`)
    3. 正しい手順で口座残高が操作される
  
これにより不正な処理であるにもかかわらず正常であるとして処理がされてしまう

### 再現方法
例としてbankcodeが`xxx`のユーザの口座に対して,
bank_code(銀行ID)が`AAA`, 
branch_code（銀行支社ID）が`BBB`, 
bankcode（通帳ID）が`CCC`, 
reason（理由）が`HOGEFUGA`として
一千万円を入金する。
クライアント側から以下のコマンドを実行する

1.  送金に使うリクエストを`util/encrypt.php`に送信し、暗号文を生成する
```sh
curl http://${SERVER_IP}/util/encrypt.php -X POST -d '{"to_bankcode": xxx, "from_bank_code": AAA, "from_branch_code": BBB, "from_bankcode": CCC, "reason": "HOGEFUGA", "value": 10000000}'
```
帰って来た結果を`ENCRYPTED_VALUE`とする。

2. 送信元を偽装したリクエストを`index.php?mode=hidden_server`に送信する
```sh
curl http://${SERVER_IP}/index.php -X POST -F 'mode=hidden_server' -F 'JSON={"mode": "payment", "data": "ENCRYPTED_VALUE"}'
```
これにより、xxxのユーザ口座に一千万円を入金することができる。
valueの値を負数にすることにより出金した扱いにすることも可能である。

### 条件
上記二点の脆弱性が実行可能であること

### 想定される被害・影響
* 実際には存在していない取引がされることによる信頼の失墜
* この手順で送金したお金を引き出す等による銀行としてのインシデントの発生

### 対策
* 上記二点の脆弱性を解決する
* 銀行同士のやりとりで共通鍵暗号ではない方法を利用することを検討する