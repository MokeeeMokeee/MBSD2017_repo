## 送信元IPでアクセスを制限しているエンドポイントでIPアドレスを偽装することができる脆弱性 
### 対象
`system.php`
`hidden_server.php`
といった接続元IPを制限するエンドポイント


### 危険度
Middle
* 送信元IPが流出した場合に銀行業務における内部処理を全て行うことができるようになる

### 解説
今回チェックを行ったアプリケーションでは、アクセス可能なURLを制御するために
以下のコードで送信元を判定している。

```php
$ret = $_SERVER['REMOTE_ADDR'];
if(isset($_SERVER['HTTP_X_FORWARDED_FOR'])){
    $ret = explode(",",$_SERVER['HTTP_X_FORWARDED_FOR'])[0];
}
```

このプログラムの現在の流れとしては以下の通りとなっている。
1. PHPプログラムに接続されてきたIPを`$ret`変数に代入する
2. もし`X-FORWARDED-FOR`ヘッダがあった場合、そのヘッダに入っている一番目の送信元ホストを`$ret`変数に代入する

しかし、今回のプログラムは`X-FORWARDED-FOR`ヘッダを利用するようなリバースプロキシを利用しておらず、
この変数に値が入ることはない。
また、先頭を取得しているため、最初についた`X-FORWARDED-FOR`ヘッダを利用している。

このプログラムには、クライアントが`X-FORWARDED-FOR`ヘッダをつけて送信した場合にはそれが利用されてしまうという問題があり、それにより
本来アクセスできないはずのエンドポイントに対してアクセスが可能になる。

リバースプロキシを使用している場合でも、ほとんどの場合はすでにヘッダが付いている場合は末尾に追加するという挙動のため
この脆弱性の影響を受ける。

### 再現方法
`curl`コマンドを導入してあるマシンで以下の処理で再現可能である。
1. 正常なリクエスト
```sh
curl http://${SERVER_IP}/index.php -X POST -F mode=system
```
送信元IPが不適切になるため、このコマンドの結果は何も帰ってこない。

2. 不正なヘッダを挿入したリクエスト 
```sh
curl http://${SERVER_IP}/index.php -X POST -F mode=system -H "X-Forwarded-For: 10.0.62.1"
```
送信元のチェックが成功するため、このコマンドでは`{"msg":"ng","no":100}`が帰る。
適切なデータを渡すことでなりすまして作業することが可能になる。
 
### 条件
上流にリバースプロキシ・WAF・IPS/IDS・ロードバランサがある場合、
`X-FORWARDED-FOR`の値を追加する場合は末尾に追加される場合に攻撃が成立する
追加しない場合は攻撃が成立する

上流にL3ルーティング・L4ロードバランスしか行わない機器しか繋がっていない場合は攻撃が成立する

悪意のあるユーザがソースコード(`consts.php`)を閲覧する等して制御IPを取得できることが必要

### 想定される被害・影響
* MBSD銀行における全操作が可能になる
* 他行との取引において利用するエンドポイントもあるため、本来行われていない送金等が行われる
  - これにより社会的信頼を失う可能性がある

### 対策
* 送信元IP制限をApacheやファイアウォール等で行うように変更する
* 送信元IPを偽装しても偽装結果が伝わらないよう、`X-FORWARDED-FOR`の値をApache側で削除するよう設定変更を行う
* リバースプロキシを挟む場合、最もクライアント側に近いリバースプロキシでそのヘッダを削除したうえで正しい送信元IPで`X-FORWARDED-FOR`ヘッダを作成しなおすようにする